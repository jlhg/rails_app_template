# ActionCable configuration for WebSocket support
# Uses dedicated Redis instance (redis_cable) for pub/sub
# Supports Docker secrets via password_file

default: &default
  adapter: redis
  # Build URL from AppConfig
  url: <%=
    host = AppConfig.instance.redis_cable_host
    port = AppConfig.instance.redis_cable_port
    password_file = AppConfig.instance.redis_cable_password_file
    db = 0  # Always use DB 0 (dedicated Redis instance)

    # Read password from file if password_file is set
    password = if password_file.present? && File.exist?(password_file)
      File.read(password_file).strip
    end

    if password.present?
      "redis://:#{password}@#{host}:#{port}/#{db}"
    else
      "redis://#{host}:#{port}/#{db}"
    end
  %>
  # Channel prefix to avoid conflicts between environments
  channel_prefix: <%= Rails.application.class.module_parent_name.underscore %>_<%= Rails.env %>

development:
  # Async adapter for development (no Redis required)
  adapter: async

test:
  # Test adapter for testing
  adapter: test

production:
  <<: *default
