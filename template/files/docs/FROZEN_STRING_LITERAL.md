# Frozen String Literal Configuration

## Overview

This project enables `frozen_string_literal` by default through Ruby's `RUBYOPT` environment variable.

## Why Use Frozen String Literal?

### Benefits

1. **Performance Improvement**
   - Avoids repeatedly creating identical string objects
   - Reduces memory allocation and garbage collection pressure

2. **Memory Optimization**
   - Identical string literals share the same object
   - Can reduce memory usage by 5-10%

3. **Code Quality**
   - Forces more explicit string operations
   - Avoids bugs from accidentally modifying strings

### Example

```ruby
# After enabling frozen_string_literal

# ❌ This will throw FrozenError
name = "John"
name << " Doe"

# ✅ Correct approach - create new string
name = "John"
name = name + " Doe"  # or use +=

# ✅ If you need a mutable string, explicitly use dup or String.new
name = "John".dup
name << " Doe"  # Now you can modify it

# ✅ Use string interpolation
first_name = "John"
full_name = "#{first_name} Doe"
```

## How to Enable

### Docker Environment (Enabled by Default)

#### Dockerfile

```dockerfile
ENV RUBYOPT="--enable-frozen-string-literal"
```

#### compose.yaml

```yaml
environment:
  - RUBYOPT=${RUBYOPT:---enable-frozen-string-literal}
```

### Local Development Environment

Two approaches:

#### Approach 1: Use Environment Variable (Recommended)

Add to `.env` file:

```bash
RUBYOPT=--enable-frozen-string-literal
```

Or set when running Rails:

```bash
export RUBYOPT="--enable-frozen-string-literal"
rails server
```

#### Approach 2: Use Magic Comment (Old Method)

Add to the first line of each Ruby file:

```ruby
# frozen_string_literal: true
```

**Note**: Since we already enable globally via `RUBYOPT`, you don't need to add this line to each file.

## Verify Configuration

### Test Script

Create test file `test_frozen.rb`:

```ruby
# Test if frozen_string_literal is enabled

puts "Testing frozen_string_literal setting..."
puts "Ruby version: #{RUBY_VERSION}"
puts "RUBYOPT: #{ENV['RUBYOPT']}"
puts ""

# Test 1: Check if string is frozen
str = "test"
puts "String literal frozen? #{str.frozen?}"

# Test 2: Try to modify (should throw error)
begin
  str << " modified"
  puts "❌ FAIL: String was modified (frozen_string_literal NOT enabled)"
rescue FrozenError => e
  puts "✅ PASS: Cannot modify frozen string (frozen_string_literal IS enabled)"
  puts "   Error: #{e.message}"
end
```

### Run Test

#### Docker Environment

```bash
docker compose exec web ruby test_frozen.rb
```

Expected output:

```
Testing frozen_string_literal setting...
Ruby version: 3.4.x
RUBYOPT: --enable-frozen-string-literal

String literal frozen? true
✅ PASS: Cannot modify frozen string (frozen_string_literal IS enabled)
   Error: can't modify frozen String: "test"
```

#### Local Environment

```bash
export RUBYOPT="--enable-frozen-string-literal"
ruby test_frozen.rb
```

## Common Questions

### Q: What to do when encountering FrozenError?

If you encounter `FrozenError` in your code, there are several solutions:

#### 1. Use String Concatenation (Recommended)

```ruby
# ❌ Don't do this
str = "Hello"
str << " World"

# ✅ Do this instead
str = "Hello"
str = str + " World"
# or
str += " World"
```

#### 2. Use String Interpolation

```ruby
# ❌ Don't do this
name = "John"
name << " Doe"

# ✅ Do this instead
first_name = "John"
last_name = "Doe"
full_name = "#{first_name} #{last_name}"
```

#### 3. Explicitly Create Mutable String

```ruby
# If you really need to modify the string
buffer = "".dup  # or String.new
buffer << "Line 1\n"
buffer << "Line 2\n"
```

### Q: What if a third-party gem is incompatible?

If you encounter errors from third-party gems due to frozen string literal:

1. **Report to gem maintainer** - This is a bug in the gem and should be fixed
2. **Temporarily disable** - Remove or comment out `RUBYOPT` setting in `.env`
3. **Disable only in specific environment** - For example, disable only in development

### Q: Doesn't Rails enable this by default?

**No**. Files generated by Rails 7+ automatically include the `# frozen_string_literal: true` magic comment, but this doesn't mean it's enabled globally.

- **Magic comment approach**: Only affects that file
- **RUBYOPT approach**: Affects all Ruby code in the entire project

Benefits of using RUBYOPT approach:
- No need to add magic comment to each file
- Ensures all code (including gems) is affected
- Easier to manage and toggle

### Q: How to disable frozen_string_literal?

#### Docker Environment

Set in `.env`:

```bash
RUBYOPT=""
```

#### Local Environment

Remove environment variable:

```bash
unset RUBYOPT
```

Or comment out in `.env`:

```bash
# RUBYOPT=--enable-frozen-string-literal
```

### Q: How much performance improvement?

According to Ruby official benchmarks:
- **Memory usage**: 5-10% reduction
- **Execution speed**: 2-5% improvement for code with heavy string operations
- **Garbage collection**: Reduced GC pressure, indirectly improving overall performance

Actual results depend on your application's string usage patterns.

## References

- [Ruby Feature #8976](https://bugs.ruby-lang.org/issues/8976) - frozen_string_literal proposal
- [Ruby Documentation - String](https://docs.ruby-lang.org/en/3.4/String.html)
- [Rails Guide - Performance](https://guides.rubyonrails.org/performance_testing.html)
